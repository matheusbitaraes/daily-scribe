version: '3.8'

services:
  # Daily Scribe FastAPI Application
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    image: daily-scribe:latest
    container_name: daily-scribe-app
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app/src:/app
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
    volumes:
      - ./data:/data:Z
      - daily_scribe_logs:/var/log/daily-scribe
      - ./config.json:/app/config.json:ro
    networks:
      - daily_scribe_internal
    ports:
      - "8000:8000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/healthz', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    command: ["python", "-m", "uvicorn", "src.api:app", "--host", "0.0.0.0", "--port", "8000"]

  # Daily Scribe Cron Jobs
  cron:
    build:
      context: .
      dockerfile: cron/Dockerfile
    image: daily-scribe-cron:latest
    container_name: daily-scribe-cron
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app/src:/app
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      - TZ=${TZ:-UTC}
    volumes:
      - ./data:/data:Z
      - daily_scribe_logs:/var/log/daily-scribe
      - daily_scribe_cron_logs:/var/log/cron
      - ./config.json:/app/config.json:ro
    networks:
      - daily_scribe_internal
    depends_on:
      - app
    healthcheck:
      test: ["CMD", "which", "supercronic"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Database Administration Tool
  cloudbeaver:
    image: dbeaver/cloudbeaver:latest
    container_name: daily-scribe-cloudbeaver
    restart: unless-stopped
    ports:
      - "8080:8978"
    volumes:
      - ./data:/opt/cloudbeaver/data  # Read-write access to database files
      - cloudbeaver_workspace:/opt/cloudbeaver/workspace
    environment:
      - CB_SERVER_NAME=Daily Scribe Database
    networks:
      - daily_scribe_internal
    depends_on:
      - app
    profiles:
      - admin

# Named volumes for data persistence
volumes:
  daily_scribe_logs:
    driver: local
  daily_scribe_cron_logs:
    driver: local
  cloudbeaver_workspace:
    driver: local

# Networks for service isolation and communication
networks:
  daily_scribe_internal:
    driver: bridge
    internal: false
